{% extends 'base.html' %}

{% block title %}ผลรางวัล - Lucky Draw{% endblock %}

{% block extra_css %}
<style>
    .results-container {
        padding: 2rem 0;
    }

    .page-title {
        text-align: center;
        margin-bottom: 3rem;
    }

    .page-title h1 {
        font-family: 'Orbitron', sans-serif;
        font-size: 2.5rem;
        font-weight: 900;
        color: #ffffff;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
    }

    .page-title p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.2rem;
        margin-top: 0.5rem;
    }

    /* Stats Section */
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        border-left: 5px solid #0033A0;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .stat-card.winners {
        border-left-color: #DAA520;
    }

    .stat-card.prizes {
        border-left-color: #0055CC;
    }

    .stat-card.people {
        border-left-color: #0033A0;
    }

    .stat-card i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .stat-card.winners i { color: #DAA520; }
    .stat-card.prizes i { color: #0055CC; }
    .stat-card.people i { color: #0033A0; }

    .stat-number {
        font-family: 'Orbitron', sans-serif;
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 0.5rem;
    }

    .stat-card.winners .stat-number { color: #DAA520; }
    .stat-card.prizes .stat-number { color: #0055CC; }
    .stat-card.people .stat-number { color: #0033A0; }

    .stat-label {
        color: #666;
        font-size: 1rem;
    }

    /* Tabs */
    .tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .tab {
        padding: 1rem 2rem;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: rgba(0, 51, 160, 0.6);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: #ffffff;
    }

    .tab:hover {
        border-color: #ffffff;
        background: rgba(0, 51, 160, 0.9);
    }

    .tab.active {
        background: #ffffff;
        color: #0033A0;
        border-color: #ffffff;
    }

    .tab.active.gold {
        background: #ffffff;
        color: #DAA520;
    }

    .tab i {
        margin-right: 0.5rem;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Results Table */
    .results-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .results-table thead {
        background: #0033A0;
    }

    .results-table th {
        padding: 1.2rem 1.5rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9rem;
        color: #ffffff;
    }

    .results-table td {
        padding: 1.2rem 1.5rem;
        border-bottom: 1px solid #eee;
        color: #333;
    }

    .prize-with-image {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .prize-image {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 8px;
        background: #f5f7fa;
        padding: 5px;
        flex-shrink: 0;
    }

    .prize-name-text {
        flex: 1;
    }

    .results-table tbody tr {
        transition: all 0.3s ease;
    }

    .results-table tbody tr:hover {
        background: #f5f7fa;
    }

    .results-table tbody tr:last-child td {
        border-bottom: none;
    }

    .results-table tbody tr.grand {
        background: #fffbf0;
    }

    .winner-name {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .winner-name .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #0033A0;
        color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 700;
    }

    .results-table tbody tr.grand .avatar {
        background: #DAA520;
    }

    .prize-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .prize-badge.grand {
        background: #DAA520;
        color: #ffffff;
    }

    .prize-badge.normal {
        background: #0033A0;
        color: white;
    }

    /* Items List */
    .items-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1rem;
    }

    .item-card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #0033A0;
    }

    .item-card:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .item-card.grand {
        border-left-color: #DAA520;
    }

    .item-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #0033A0;
        color: #ffffff;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 700;
        flex-shrink: 0;
    }

    .item-card.grand .item-avatar {
        background: #DAA520;
    }

    .item-details {
        flex: 1;
        min-width: 0;
    }

    .item-name {
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #333;
    }

    .item-status {
        font-size: 0.85rem;
        color: #999;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .item-status.grand {
        color: #DAA520;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: #f9f9f9;
        border-radius: 15px;
        border: 2px dashed #ddd;
    }

    .empty-state i {
        font-size: 4rem;
        color: #ccc;
        margin-bottom: 1.5rem;
    }

    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #666;
    }

    .empty-state p {
        color: #999;
    }

    /* Search Box */
    .search-container {
        margin-bottom: 2rem;
        display: flex;
        justify-content: center;
    }

    .search-box {
        position: relative;
        max-width: 600px;
        width: 100%;
    }

    .search-box input {
        width: 100%;
        padding: 1rem 1rem 1rem 3.5rem;
        border-radius: 50px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.95);
        font-size: 1rem;
        color: #333;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .search-box input:focus {
        outline: none;
        border-color: #0033A0;
        box-shadow: 0 0 20px rgba(0, 51, 160, 0.3);
        background: #ffffff;
    }

    .search-box input::placeholder {
        color: #999;
    }

    .search-box i {
        position: absolute;
        left: 1.3rem;
        top: 50%;
        transform: translateY(-50%);
        color: #0033A0;
        font-size: 1.2rem;
    }

    .search-box .clear-search {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        cursor: pointer;
        font-size: 1.2rem;
        display: none;
        padding: 0.3rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .search-box .clear-search:hover {
        color: #0033A0;
        background: rgba(0, 51, 160, 0.1);
    }

    .search-box input:not(:placeholder-shown) + i + .clear-search {
        display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-title h1 {
            font-size: 2rem;
        }

        .results-table {
            display: block;
            overflow-x: auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container results-container">
    <div class="page-title">
        <h1><i class="fas fa-trophy"></i> ผลรางวัล</h1>
        <p>ประวัติการสุ่มรางวัลทั้งหมด</p>
    </div>

    <!-- Stats -->
    <div class="stats-section">
        <div class="stat-card winners">
            <i class="fas fa-trophy"></i>
            <div class="stat-number">{{ history|length }}</div>
            <div class="stat-label">ผู้ได้รับรางวัล</div>
        </div>
        <div class="stat-card people">
            <i class="fas fa-users"></i>
            <div class="stat-number">{{ non_winners|length }}</div>
            <div class="stat-label">รอลุ้นรางวัล</div>
        </div>
        <div class="stat-card prizes">
            <i class="fas fa-gift"></i>
            <div class="stat-number">{{ unclaimed_prizes|length }}</div>
            <div class="stat-label">รางวัลที่เหลือ</div>
        </div>
    </div>

    <!-- Search Box -->
    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="ค้นหาชื่อผู้โชคดี, รางวัล, หรือชื่อผู้เข้าร่วม..." oninput="filterResults()">
            <span class="clear-search" onclick="clearSearch()" title="ล้างการค้นหา">
                <i class="fas fa-times"></i>
            </span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active gold" onclick="switchTab('winners')">
            <i class="fas fa-trophy"></i> ผู้ได้รับรางวัล ({{ history|length }})
        </div>
        <div class="tab" onclick="switchTab('waiting')">
            <i class="fas fa-users"></i> รอลุ้นรางวัล ({{ non_winners|length }})
        </div>
        <div class="tab" onclick="switchTab('prizes')">
            <i class="fas fa-gift"></i> รางวัลที่เหลือ ({{ unclaimed_prizes|length }})
        </div>
    </div>

    <!-- Winners Tab -->
    <div id="winners-tab" class="tab-content active">
        {% if history|length > 0 %}
        <table class="results-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ผู้โชคดี</th>
                    <th>รางวัลที่ได้</th>
                    <th>ประเภท</th>
                </tr>
            </thead>
            <tbody id="winners-tbody">
                {% for h in history %}
                <tr class="searchable-item {% if h.is_grand %}grand{% endif %}" 
                    data-name="{{ h.participant_name }}" 
                    data-prize="{{ h.prize_name }}">
                    <td>{{ loop.index }}</td>
                    <td>
                        <div class="winner-name">
                            <div class="avatar">{{ h.participant_name[0] }}</div>
                            {{ h.participant_name }}
                        </div>
                    </td>
                    <td>
                        <div class="prize-with-image">
                            {% set prize_key = (h.prize_name, h.is_grand) %}
                            {% set prize_image = prize_image_map.get(prize_key, '') %}
                            {% if prize_image and prize_image.strip() != '' and prize_image != 'None' %}
                            <img src="/static/{{ prize_image }}" alt="{{ h.prize_name }}" class="prize-image" onerror="this.style.display='none';">
                            {% endif %}
                            <span class="prize-name-text">{{ h.prize_name }}</span>
                        </div>
                    </td>
                    <td>
                        {% if h.is_grand %}
                        <span class="prize-badge grand">
                            <i class="fas fa-crown"></i> รางวัลใหญ่
                        </span>
                        {% else %}
                        <span class="prize-badge normal">
                            <i class="fas fa-gift"></i> รางวัลทั่วไป
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>ยังไม่มีผู้ได้รับรางวัล</h3>
            <p>เริ่มสุ่มรางวัลเพื่อดูผลลัพธ์</p>
        </div>
        {% endif %}
    </div>

    <!-- Waiting Tab -->
    <div id="waiting-tab" class="tab-content">
        {% if non_winners|length > 0 %}
        <div class="items-list" id="waiting-list">
            {% for person in non_winners %}
            <div class="item-card searchable-item" data-name="{{ person.name }}">
                <div class="item-avatar">{{ person.name[0] }}</div>
                <div class="item-details">
                    <div class="item-name">{{ person.name }}</div>
                    <div class="item-status">
                        <i class="fas fa-clock"></i> รอลุ้นรางวัล
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>ทุกคนได้รับรางวัลแล้ว!</h3>
            <p>หรือยังไม่มีผู้เข้าร่วม</p>
        </div>
        {% endif %}
    </div>

    <!-- Prizes Tab -->
    <div id="prizes-tab" class="tab-content">
        {% if unclaimed_prizes|length > 0 %}
        <div class="items-list" id="prizes-list">
            {% for prize in unclaimed_prizes %}
            <div class="item-card searchable-item {% if prize.is_grand %}grand{% endif %}" 
                 data-name="{{ prize.name }}">
                <div class="item-avatar">
                    <i class="fas {% if prize.is_grand %}fa-crown{% else %}fa-gift{% endif %}"></i>
                </div>
                <div class="item-details">
                    <div class="item-name">{{ prize.name }}</div>
                    <div class="item-status {% if prize.is_grand %}grand{% endif %}">
                        <i class="fas {% if prize.is_grand %}fa-crown{% else %}fa-gift{% endif %}"></i>
                        {% if prize.is_grand %}รางวัลใหญ่{% else %}รางวัลทั่วไป{% endif %}
                        <span style="margin-left: 8px; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; color: #333; font-size: 0.75rem;">
                            เหลือ {{ prize.remaining }}/{{ prize.quantity }}
                        </span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-gift"></i>
            <h3>รางวัลถูกสุ่มหมดแล้ว!</h3>
            <p>หรือยังไม่มีรางวัลในระบบ</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // เรียก filterResults อีกครั้งเมื่อเปลี่ยนแท็บ
        filterResults();
    }

    function filterResults() {
        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput.value.toLowerCase().trim();
        const activeTab = document.querySelector('.tab-content.active');
        
        if (!activeTab) return;
        
        // กรองตามแท็บที่เปิดอยู่
        if (activeTab.id === 'winners-tab') {
            // กรองตารางผู้ได้รับรางวัล
            const rows = activeTab.querySelectorAll('.searchable-item');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const prize = row.getAttribute('data-prize') || '';
                const searchText = (name + ' ' + prize).toLowerCase();
                
                if (searchTerm === '' || searchText.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // แสดงข้อความถ้าไม่พบผลลัพธ์
            let emptyState = activeTab.querySelector('.no-results-message');
            if (searchTerm !== '' && visibleCount === 0) {
                if (!emptyState) {
                    emptyState = document.createElement('div');
                    emptyState.className = 'empty-state no-results-message';
                    emptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <h3>ไม่พบผลลัพธ์</h3>
                        <p>ไม่พบข้อมูลที่ตรงกับ "${searchInput.value}"</p>
                    `;
                    activeTab.appendChild(emptyState);
                }
                emptyState.style.display = 'block';
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
            
        } else if (activeTab.id === 'waiting-tab' || activeTab.id === 'prizes-tab') {
            // กรองรายการรอลุ้นรางวัลหรือรางวัลที่เหลือ
            const items = activeTab.querySelectorAll('.searchable-item');
            let visibleCount = 0;
            
            items.forEach(item => {
                const name = item.getAttribute('data-name') || '';
                const searchText = name.toLowerCase();
                
                if (searchTerm === '' || searchText.includes(searchTerm)) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // แสดงข้อความถ้าไม่พบผลลัพธ์
            let emptyState = activeTab.querySelector('.no-results-message');
            if (searchTerm !== '' && visibleCount === 0) {
                if (!emptyState) {
                    emptyState = document.createElement('div');
                    emptyState.className = 'empty-state no-results-message';
                    emptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <h3>ไม่พบผลลัพธ์</h3>
                        <p>ไม่พบข้อมูลที่ตรงกับ "${searchInput.value}"</p>
                    `;
                    activeTab.appendChild(emptyState);
                }
                emptyState.style.display = 'block';
            } else if (emptyState) {
                emptyState.style.display = 'none';
            }
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        filterResults();
        searchInput.focus();
    }

    // เก็บข้อมูลปัจจุบันสำหรับเปรียบเทียบ
    let currentData = {
        history_count: {{ history|length }},
        non_winners_count: {{ non_winners|length }},
        unclaimed_prizes_count: {{ unclaimed_prizes|length }},
        latest_timestamp: null
    };
    
    // ตัวแปรสำหรับเก็บ timeout ที่จะ refresh หลังจาก 10 วินาที
    let pendingRefreshTimeout = null;
    let isRefreshPending = false;
    
    // ดึงข้อมูล timestamp ปัจจุบันเมื่อโหลดหน้าแรก
    async function loadInitialData() {
        try {
            const response = await fetch('/api/results/check');
            const data = await response.json();
            currentData.latest_timestamp = data.latest_timestamp;
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    }
    
    // Polling function - เช็คข้อมูลทุก 3 วินาที
    let checkInterval;
    function startDataCheck() {
        // เช็คทุก 3 วินาที
        checkInterval = setInterval(async function() {
            // ตรวจสอบว่าผู้ใช้กำลังพิมพ์ในช่องค้นหาหรือไม่
            const searchInput = document.getElementById('searchInput');
            if (document.activeElement === searchInput) {
                // ถ้ากำลังพิมพ์ ให้ข้ามการเช็คครั้งนี้
                return;
            }
            
            try {
                const response = await fetch('/api/results/check');
                const newData = await response.json();
                
                // เปรียบเทียบข้อมูล
                const hasChanged = 
                    newData.history_count !== currentData.history_count ||
                    newData.non_winners_count !== currentData.non_winners_count ||
                    newData.unclaimed_prizes_count !== currentData.unclaimed_prizes_count ||
                    newData.latest_timestamp !== currentData.latest_timestamp;
                
                if (hasChanged && !isRefreshPending) {
                    // พบข้อมูลใหม่ - รอ 10 วินาทีแล้วค่อย refresh
                    isRefreshPending = true;
                    
                    // ล้าง timeout เก่าถ้ามี
                    if (pendingRefreshTimeout) {
                        clearTimeout(pendingRefreshTimeout);
                    }
                    
                    // ตั้ง timeout สำหรับ refresh หลังจาก 10 วินาที
                    pendingRefreshTimeout = setTimeout(function() {
                        // อัพเดทข้อมูลปัจจุบัน
                        currentData = newData;
                        isRefreshPending = false;
                        // Reload หน้าเว็บ
                        window.location.reload();
                    }, 10000); // 10000 milliseconds = 10 วินาที
                } else if (!hasChanged && isRefreshPending) {
                    // ถ้าข้อมูลกลับมาเหมือนเดิม ให้ยกเลิกการ refresh ที่รออยู่
                    if (pendingRefreshTimeout) {
                        clearTimeout(pendingRefreshTimeout);
                        pendingRefreshTimeout = null;
                    }
                    isRefreshPending = false;
                }
            } catch (error) {
                console.error('Error checking for updates:', error);
            }
        }, 3000); // เช็คทุก 3 วินาที
    }

    // เรียก filterResults เมื่อโหลดหน้าเพื่อเตรียมพร้อม
    document.addEventListener('DOMContentLoaded', async function() {
        filterResults();
        // โหลดข้อมูล timestamp ปัจจุบัน
        await loadInitialData();
        // เริ่มการเช็คข้อมูล
        startDataCheck();
    });

    // หยุดการเช็คเมื่อผู้ใช้ออกจากหน้า
    window.addEventListener('beforeunload', function() {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
        if (pendingRefreshTimeout) {
            clearTimeout(pendingRefreshTimeout);
        }
    });
</script>
{% endblock %}
